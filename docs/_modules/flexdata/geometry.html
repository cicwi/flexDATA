<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>flexdata.geometry &mdash; flexdata  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            flexdata
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../flexdata.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">flexdata</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">flexdata.geometry</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for flexdata.geometry</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains acquisition geometry classes: circular, linear, helical.</span>
<span class="sd">The circular class corresponds to the simplest case of circular orbit cone-beam CT with minimal number of parameters.</span>
<span class="sd">Additional parameters can be use to define a non-conventional geometry.</span>
<span class="sd">For instance: offsets and rotations (&#39;det_roll&#39;, &#39;det_tan&#39;, &#39;det_ort&#39;, etc.), axis tilts (&#39;axs_roll&#39;, &#39;axs_pitch&#39;),</span>
<span class="sd">volume transformations (&#39;vol_tra&#39;, &#39;vol_rot&#39;), recostruction resolution and anisotropic sampling (&#39;img_pixel&#39;, &#39;det_sample&#39;, &#39;vol_sample&#39;).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Imports &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">FLEXTOML_VERSION</span> <span class="o">=</span> <span class="s1">&#39;0.1.0&#39;</span>


<span class="c1"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Classes &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<div class="viewcode-block" id="basic">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic">[docs]</a>
<span class="k">class</span> <span class="nc">basic</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Base geometry class. Needs only SDD, ODD and pixel size to initialize.</span>
<span class="sd">    Use &#39;parameters&#39; to store parameters and &#39;description&#39; to store relevant metadata.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src2obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">det2obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">det_pixel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">img_pixel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor for the base geometry class.</span>

<span class="sd">        Args:</span>
<span class="sd">            src2obj  : source to detector distance</span>
<span class="sd">            det2obj  : object to detector distance</span>
<span class="sd">            det_pixel: detector pixel size</span>
<span class="sd">            img_pixel: reconstruction volume voxel size (optional)</span>
<span class="sd">            unit     : unit length (default = &#39;mm&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Default voxel size:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">img_pixel</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">det_pixel</span><span class="p">):</span> <span class="n">img_pixel</span> <span class="o">=</span> <span class="n">det_pixel</span> <span class="o">/</span> <span class="p">(</span><span class="n">src2obj</span> <span class="o">+</span> <span class="n">det2obj</span><span class="p">)</span> <span class="o">*</span> <span class="n">src2obj</span>

        <span class="c1"># Parameters:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;src2obj&#39;</span><span class="p">:</span><span class="n">src2obj</span><span class="p">,</span>
                           <span class="s1">&#39;det2obj&#39;</span><span class="p">:</span><span class="n">det2obj</span><span class="p">,</span>

                           <span class="s1">&#39;det_pixel&#39;</span><span class="p">:</span><span class="n">det_pixel</span><span class="p">,</span>
                           <span class="s1">&#39;img_pixel&#39;</span><span class="p">:</span><span class="n">img_pixel</span><span class="p">,</span>
                           <span class="s1">&#39;unit&#39;</span><span class="p">:</span><span class="n">unit</span><span class="p">,</span>

                           <span class="s1">&#39;axs_tan&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>                 <span class="c1"># rotation axis translation</span>
                           <span class="s1">&#39;vol_rot&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>   <span class="c1"># volume rotations and translation vectors</span>
                           <span class="s1">&#39;vol_tra&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>

                           <span class="s1">&#39;det_sample&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>          <span class="c1"># detector and volume sampling (use to indicate that pixels were binned)</span>
                           <span class="s1">&#39;vol_sample&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                           <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;flextoml_version&#39;</span><span class="p">:</span> <span class="n">FLEXTOML_VERSION</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Show my description.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;Geometry class: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Parameters: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Show my description.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;Geometry class: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Parameters: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Retrieve one of the geometry parameters.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING! A property with an unknown key is requested: &#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set one of the geometry parameters.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING! A property with an unknown key is added to geometry: &#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<div class="viewcode-block" id="basic.copy">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Copy me.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">geom</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">geom</span></div>


<div class="viewcode-block" id="basic.to_dictionary">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.to_dictionary">[docs]</a>
    <span class="k">def</span> <span class="nf">to_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a dictionary describing this geometry.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">records</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">records</span></div>


<div class="viewcode-block" id="basic.from_matrix">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.from_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">from_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotates and translates the reconstruction volume.</span>

<span class="sd">        Args:</span>
<span class="sd">            R (3x3 array): rotation matrix</span>
<span class="sd">            T (1x3 array): translation vector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Translate to flex geometry:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vol_rot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mat2euler</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;sxyz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vol_tra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vol_tra&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">)[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel</span></div>


<div class="viewcode-block" id="basic.from_dictionary">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.from_dictionary">[docs]</a>
    <span class="k">def</span> <span class="nf">from_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Use dictionary records to initialize this geometry.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Fill gaps if needed:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src2obj&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src2det&#39;</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Filed missing in geometry record: src2det&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;det2obj&#39;</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Filed missing in geometry record: det2obj&#39;</span><span class="p">)</span>

            <span class="n">dictionary</span><span class="p">[</span><span class="s1">&#39;src2obj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="s1">&#39;src2det&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dictionary</span><span class="p">[</span><span class="s1">&#39;det2obj&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;det2obj&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src2det&#39;</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Filed missing in geometry record: src2det&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dictionary</span><span class="p">[</span><span class="s1">&#39;det2obj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="s1">&#39;src2det&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dictionary</span><span class="p">[</span><span class="s1">&#39;src2obj&#39;</span><span class="p">]</span>

        <span class="c1"># Copy records:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># After-check:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;img_pixel&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;img_pixel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_pixel&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnification</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;det_pixel&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_pixel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;img_pixel&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnification</span>

        <span class="c1"># Check if all necessary keys are there:</span>
        <span class="n">min_set</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;src2obj&#39;</span><span class="p">,</span> <span class="s1">&#39;det2obj&#39;</span><span class="p">,</span> <span class="s1">&#39;det_pixel&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">min_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Geometry parameter missing after parcing: &#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="basic.log">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.log">[docs]</a>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a message to the geometry changelog.</span>

<span class="sd">        This changelog will be saved with the geometry in a toml file.</span>

<span class="sd">        :param message: A message to log (single line).</span>
<span class="sd">        :returns: None</span>
<span class="sd">        :rtype: NoneType</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">changelog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;changelog&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">changelog</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">:</span><span class="s2">%Y-%m-%d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;changelog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">changelog</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vol_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Voxel shape.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_sample&#39;</span><span class="p">)</span>

    <span class="nd">@vol_sample</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vol_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Voxel shape.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vol_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">det_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Pixel shape.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;det_sample&#39;</span><span class="p">)</span>

    <span class="nd">@det_sample</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">det_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Pixel shape.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Pixel size (mm).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;det_pixel&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;det_sample&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">voxel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Voxel size (mm).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;img_pixel&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vol_sample&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">src2obj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Source-to-object distance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src2obj&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">det2obj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Detector-to-object distance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;det2obj&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">src2det</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Source-to-detector distance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src2obj&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;det2obj&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">magnification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Magnification.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">src2det</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">src2obj</span>

<div class="viewcode-block" id="basic.volume_xyz">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.volume_xyz">[docs]</a>
    <span class="k">def</span> <span class="nf">volume_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Coordinate grid in units of the geometry.</span>

<span class="sd">        Args:</span>
<span class="sd">            shape : volume shape</span>
<span class="sd">            offset: offset in length units</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span></div>


<div class="viewcode-block" id="basic.from_astra_cone_vec">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.from_astra_cone_vec">[docs]</a>
    <span class="k">def</span> <span class="nf">from_astra_cone_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vectors</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Take vectors from ASTRA &#39;cone_vec&#39; geometry. This will override any other parameters.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vectors_</span> <span class="o">=</span> <span class="n">vectors</span></div>


<div class="viewcode-block" id="basic.astra_projection_geom">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.astra_projection_geom">[docs]</a>
    <span class="k">def</span> <span class="nf">astra_projection_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get ASTRA projection geometry.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_shape: [detector_count_z, theta_count, detector_count_x]</span>
<span class="sd">            index     : if provided - sequence of the rotation angles</span>

<span class="sd">        Returns:</span>
<span class="sd">            geometry : ASTRA cone-beam geometry.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">astra</span>

        <span class="c1"># Get vectors:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_vectors_&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors_</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vectors_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vectors</span><span class="p">(</span><span class="n">data_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">index</span><span class="p">)</span>

        <span class="c1"># Get ASTRA geometry:</span>
        <span class="n">det_count_x</span> <span class="o">=</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">det_count_z</span> <span class="o">=</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">astra</span><span class="o">.</span><span class="n">create_proj_geom</span><span class="p">(</span><span class="s1">&#39;cone_vec&#39;</span><span class="p">,</span> <span class="n">det_count_z</span><span class="p">,</span> <span class="n">det_count_x</span><span class="p">,</span> <span class="n">vectors</span><span class="p">)</span></div>


<div class="viewcode-block" id="basic.astra_volume_geom">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.astra_volume_geom">[docs]</a>
    <span class="k">def</span> <span class="nf">astra_volume_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol_shape</span><span class="p">,</span> <span class="n">slice_first</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">slice_last</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize ASTRA volume geometry.</span>

<span class="sd">        Args:</span>
<span class="sd">            vol_shape  : volume array shape</span>
<span class="sd">            slice_first: first slice of an ROI to update</span>
<span class="sd">            slice_last : last slice of an ROI to update</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">astra</span>

        <span class="c1"># Shape and size (mm) of the volume</span>
        <span class="n">vol_shape</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vol_shape</span><span class="p">)</span>
        <span class="n">vol_size</span> <span class="o">=</span> <span class="n">vol_shape</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">slice_first</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">slice_last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Generate volume geometry for one chunk of data:</span>

            <span class="n">length</span> <span class="o">=</span> <span class="n">vol_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Compute offset from the centre:</span>
            <span class="n">centre</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">slice_first</span> <span class="o">+</span> <span class="n">slice_last</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">centre</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">slice_last</span> <span class="o">-</span> <span class="n">slice_first</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vol_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vol_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">vol_size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">vol_shape</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#vol_geom = astra.creators.create_vol_geom(shape[1], shape[2], shape[0],</span>
        <span class="n">vol_geom</span> <span class="o">=</span> <span class="n">astra</span><span class="o">.</span><span class="n">create_vol_geom</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="o">-</span><span class="n">vol_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">vol_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">vol_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">vol_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                  <span class="o">-</span><span class="n">vol_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">vol_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vol_geom</span></div>


<div class="viewcode-block" id="basic.get_vectors">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.get_vectors">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get source, detector and detector orientation vectors.</span>

<span class="sd">        Args:</span>
<span class="sd">            angle_count : number of rotation angles</span>
<span class="sd">            index       : index of angles that should be used</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Create source orbit:</span>
        <span class="n">src_vect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_orbit</span><span class="p">(</span><span class="n">proj_count</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="c1"># Create detector orbit (same as source but 180 degrees offset):</span>
        <span class="n">det_vect</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_detector_orbit</span><span class="p">(</span><span class="n">proj_count</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="c1"># Apply global rotations and translations:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transform_vectors_</span><span class="p">(</span><span class="n">src_vect</span><span class="p">,</span> <span class="n">det_vect</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span><span class="p">)</span>

        <span class="c1"># Append all vectors together:</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">src_vect</span><span class="p">,</span> <span class="n">det_vect</span><span class="p">,</span> <span class="n">det_tan</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">det_orth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vectors</span></div>


<div class="viewcode-block" id="basic.get_source_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.get_source_orbit">[docs]</a>
    <span class="k">def</span> <span class="nf">get_source_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the source orbit. In the base class it is a circular orbit.</span>

<span class="sd">        Args:</span>
<span class="sd">            proj_count: number of projections</span>
<span class="sd">            index           : index of the projection subset</span>

<span class="sd">        Returns:</span>
<span class="sd">            src_pos : array of the source positions. Can be generated by circular_orbit(...), for instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Override this method in a geometry class derived from the base class!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="basic.get_detector_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.get_detector_orbit">[docs]</a>
    <span class="k">def</span> <span class="nf">get_detector_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the detector orbit. In the base class it is a circular orbit.</span>

<span class="sd">        Args:</span>
<span class="sd">            proj_count: number of projections</span>
<span class="sd">            index           : index of the projection subset</span>
<span class="sd">        Returns:</span>
<span class="sd">            src_pos : array of the source positions. Can be generated by circular_orbit(...), for instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Override this method in a geometry class derived from the base class!&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_transform_vectors_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_vect</span><span class="p">,</span> <span class="n">det_vect</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Rotate and translate vectors depending on the volume orientation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">vol_rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vol_rot&#39;</span><span class="p">]</span>
        <span class="n">vol_tra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vol_tra&#39;</span><span class="p">]</span>

        <span class="c1"># Rotate everything relative to the reconstruction volume:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">_euler2mat_</span><span class="p">(</span><span class="n">vol_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vol_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vol_rot</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;rzyx&#39;</span><span class="p">)</span>
        <span class="n">det_tan</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_tan</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="n">det_rad</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_rad</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="n">det_orth</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_orth</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="n">src_vect</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">src_vect</span><span class="p">,</span><span class="n">R</span><span class="p">)</span>
        <span class="n">det_vect</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_vect</span><span class="p">,</span><span class="n">R</span><span class="p">)</span>

        <span class="c1"># Add translation:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vol_tra</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vol_tra</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">vol_tra</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">src_vect</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="n">det_vect</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>

<div class="viewcode-block" id="basic.detector_size">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.detector_size">[docs]</a>
    <span class="k">def</span> <span class="nf">detector_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_shape</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the size of detector in length units.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">proj_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">proj_shape</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">proj_shape</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel</span></div>


<div class="viewcode-block" id="basic.detector_centre">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.detector_centre">[docs]</a>
    <span class="k">def</span> <span class="nf">detector_centre</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the centre coordinate of the first position of the detector.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">det_pos</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_detector_orbit</span><span class="p">(</span><span class="n">proj_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">det_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">det_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span></div>


<div class="viewcode-block" id="basic.detector_bounds">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.detector_bounds">[docs]</a>
    <span class="k">def</span> <span class="nf">detector_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_shape</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the boundaries of the detector at the start of the scan in length units.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">det_pos</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_detector_orbit</span><span class="p">(</span><span class="n">proj_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector_size</span><span class="p">(</span><span class="n">proj_shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">cntr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector_centre</span><span class="p">()</span>

        <span class="n">vrt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">hrz</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vrt</span><span class="p">,</span> <span class="n">hrz</span><span class="p">])</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cntr</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span></div>


<div class="viewcode-block" id="basic.volume_size">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.volume_size">[docs]</a>
    <span class="k">def</span> <span class="nf">volume_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol_shape</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return volume size in length units.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vol_shape</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">voxel</span></div>


<div class="viewcode-block" id="basic.volume_bounds">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.basic.volume_bounds">[docs]</a>
    <span class="k">def</span> <span class="nf">volume_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol_shape</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return volume bounds:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_size</span><span class="p">(</span><span class="n">vol_shape</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">vrt</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sz</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sz</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">hrz</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sz</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vrt</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">hrz</span><span class="p">])</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vol_tra&#39;</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]</span></div>
</div>


<div class="viewcode-block" id="circular">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.circular">[docs]</a>
<span class="k">class</span> <span class="nc">circular</span><span class="p">(</span><span class="n">basic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Circular orbit geometry class. Includes additional parameters such as detector and source shifts and rotations.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src2obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">det2obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">det_pixel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">img_pixel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ang_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">),</span> <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor for the circular geometry class.</span>

<span class="sd">        Args:</span>
<span class="sd">            src2obj  : source to detector distance</span>
<span class="sd">            det2obj  : object to detector distance</span>
<span class="sd">            det_pixel: detector pixel size</span>
<span class="sd">            img_pixel: reconstruction volume voxel size (optional)</span>
<span class="sd">            ang_range: range of rotation (default = 0..360)</span>
<span class="sd">            unit     : unit length (default = &#39;mm&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Parent init:</span>
        <span class="n">basic</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src2obj</span><span class="p">,</span> <span class="n">det2obj</span><span class="p">,</span> <span class="n">det_pixel</span><span class="p">,</span> <span class="n">img_pixel</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

        <span class="c1"># Additional parameters:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                           <span class="s1">&#39;ang_range&#39;</span><span class="p">:</span> <span class="n">ang_range</span><span class="p">,</span>
                           <span class="s1">&#39;src_ort&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>   <span class="c1"># source vertical, tangential shifts</span>
                           <span class="s1">&#39;src_tan&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>

                           <span class="s1">&#39;det_ort&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>   <span class="c1"># detector shifts and rotations (in degrees)</span>
                           <span class="s1">&#39;det_tan&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                           <span class="s1">&#39;det_roll&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                           <span class="s1">&#39;det_pitch&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                           <span class="s1">&#39;det_yaw&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>

                           <span class="s1">&#39;axs_roll&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># rotation axis roll and pitch (in degrees)</span>
                           <span class="s1">&#39;axs_pitch&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                           <span class="p">})</span>

<div class="viewcode-block" id="circular.get_thetas">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.circular.get_thetas">[docs]</a>
    <span class="k">def</span> <span class="nf">get_thetas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get rotation angles. Either returns an equidistant array or self.thetas if that is defined.</span>

<span class="sd">        Args:</span>
<span class="sd">            proj_count : number of angles in equidistant case. Not used if &#39;thetas&#39; are defined explicitly in parameters.</span>

<span class="sd">        Returns:</span>
<span class="sd">            thetas : angle array in degrees</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thetas&#39;</span><span class="p">)</span>

        <span class="c1"># Initialize thetas:</span>
        <span class="k">if</span> <span class="n">thetas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">thetas</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ang_range&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ang_range&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">proj_count</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">thetas</span> <span class="o">=</span> <span class="n">thetas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">thetas</span></div>


<div class="viewcode-block" id="circular.get_source_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.circular.get_source_orbit">[docs]</a>
    <span class="k">def</span> <span class="nf">get_source_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the source orbit.</span>

<span class="sd">        Args:</span>
<span class="sd">            proj_count: number of projections</span>
<span class="sd">            index     : index of the projection subset</span>

<span class="sd">        Returns:</span>
<span class="sd">            src_pos : array of the source positions.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">src2obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src2obj</span>

        <span class="n">src_ort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;src_ort&#39;</span><span class="p">]</span>
        <span class="n">src_tan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;src_tan&#39;</span><span class="p">]</span>

        <span class="n">axs_tan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_tan&#39;</span><span class="p">]</span>

        <span class="n">axs_roll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_roll&#39;</span><span class="p">]</span>
        <span class="n">axs_pitch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_pitch&#39;</span><span class="p">]</span>

        <span class="c1"># Create source orbit:</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_thetas</span><span class="p">(</span><span class="n">proj_count</span><span class="p">)</span>

        <span class="c1"># src_ort may be a vector or a scalar:</span>
        <span class="n">org</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">src_ort</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">src_vect</span><span class="p">,</span> <span class="n">src_tan</span><span class="p">,</span> <span class="n">src_rad</span><span class="p">,</span> <span class="n">serc_orth</span> <span class="o">=</span> <span class="n">circular_orbit</span><span class="p">(</span><span class="n">src2obj</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">roll</span> <span class="o">=</span> <span class="n">axs_roll</span><span class="p">,</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">axs_pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                         <span class="n">origin</span> <span class="o">=</span> <span class="n">org</span><span class="p">,</span> <span class="n">tan_shift</span> <span class="o">=</span> <span class="n">src_tan</span> <span class="o">-</span> <span class="n">axs_tan</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">src_vect</span></div>


<div class="viewcode-block" id="circular.get_detector_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.circular.get_detector_orbit">[docs]</a>
    <span class="k">def</span> <span class="nf">get_detector_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the detector orbit.</span>

<span class="sd">        Args:</span>
<span class="sd">            proj_count: number of projections</span>
<span class="sd">            index           : index of the projection subset</span>

<span class="sd">        Returns:</span>
<span class="sd">            det_pos : array of the detector positions.</span>
<span class="sd">            det_tan : array of detector tangential directional vector</span>
<span class="sd">            det_rad : array of detector radial directional vector</span>
<span class="sd">            det_orth: array of detector orthogonal directional vector</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">det2obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">det2obj</span>

        <span class="c1"># Detector translations:</span>
        <span class="n">det_ort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_ort&#39;</span><span class="p">]</span>
        <span class="n">det_tan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_tan&#39;</span><span class="p">]</span>

        <span class="c1"># Rotation axis translations and rotations:</span>
        <span class="n">axs_tan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_tan&#39;</span><span class="p">]</span>

        <span class="n">axs_roll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_roll&#39;</span><span class="p">]</span>
        <span class="n">axs_pitch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_pitch&#39;</span><span class="p">]</span>

        <span class="c1"># Detector rotations:</span>
        <span class="n">det_roll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_roll&#39;</span><span class="p">]</span>
        <span class="n">det_yaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_yaw&#39;</span><span class="p">]</span>
        <span class="n">det_pitch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_pitch&#39;</span><span class="p">]</span>

        <span class="c1"># Create detector orbit:</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_thetas</span><span class="p">(</span><span class="n">proj_count</span><span class="p">)</span>

        <span class="c1"># det_ort may be a vector or a scalar:</span>
        <span class="n">org</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">det_ort</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">det_pos</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span> <span class="o">=</span> <span class="n">circular_orbit</span><span class="p">(</span><span class="n">det2obj</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">roll</span> <span class="o">=</span> <span class="n">axs_roll</span><span class="p">,</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">axs_pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
                                                         <span class="n">origin</span> <span class="o">=</span> <span class="n">org</span><span class="p">,</span> <span class="n">tan_shift</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_tan</span> <span class="o">+</span> <span class="n">axs_tan</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">)</span>

        <span class="c1"># Invert vectors to keep them alligned with the source vectors:</span>
        <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_tan</span><span class="p">,</span> <span class="o">-</span><span class="n">det_rad</span><span class="p">,</span> <span class="o">-</span><span class="n">det_orth</span>

        <span class="c1"># Apply detector rotations:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">det_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">det_roll</span><span class="p">)</span>
            <span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">det_yaw</span><span class="p">)</span>
            <span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">det_pitch</span><span class="p">)</span>
            <span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>

        <span class="k">return</span> <span class="n">det_pos</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span></div>
</div>


<div class="viewcode-block" id="helical">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.helical">[docs]</a>
<span class="k">class</span> <span class="nc">helical</span><span class="p">(</span><span class="n">circular</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Helical orbit geometry class. Similar to the &#39;circular&#39; class with additional parameter of helix</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src2obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">det2obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">det_pixel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">img_pixel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>  <span class="n">ang_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">720</span><span class="p">),</span> <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor for the helical geometry class.</span>

<span class="sd">        Args:</span>
<span class="sd">            src2obj  : source to detector distance</span>
<span class="sd">            det2obj  : object to detector distance</span>
<span class="sd">            det_pixel: detector pixel size</span>
<span class="sd">            img_pixel: reconstruction volume voxel size (optional)</span>
<span class="sd">            axis_range: range of the movement along the axis of rotation</span>
<span class="sd">            ang_range: range of angles (default = 0..360)</span>
<span class="sd">            unit     : unit length (default = &#39;mm&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Parent init:</span>
        <span class="n">circular</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src2obj</span><span class="p">,</span> <span class="n">det2obj</span><span class="p">,</span> <span class="n">det_pixel</span><span class="p">,</span> <span class="n">img_pixel</span><span class="p">,</span> <span class="n">ang_range</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

        <span class="c1"># Additional parameters:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_rng&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis_range</span>

<div class="viewcode-block" id="helical.get_source_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.helical.get_source_orbit">[docs]</a>
    <span class="k">def</span> <span class="nf">get_source_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the source orbit. In the base class it is a circular orbit.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">src2obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src2obj</span>

        <span class="n">src_ort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;src_ort&#39;</span><span class="p">]</span>
        <span class="n">src_tan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;src_tan&#39;</span><span class="p">]</span>

        <span class="n">axs_tan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_tan&#39;</span><span class="p">]</span>

        <span class="n">axs_roll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_roll&#39;</span><span class="p">]</span>
        <span class="n">axs_pitch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_pitch&#39;</span><span class="p">]</span>

        <span class="c1"># Create source orbit:</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_thetas</span><span class="p">(</span><span class="n">proj_count</span><span class="p">)</span>

        <span class="c1"># src_ort may be a vector or a scalar:</span>
        <span class="n">org</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">src_ort</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">src_vect</span><span class="p">,</span> <span class="n">src_tan</span><span class="p">,</span> <span class="n">src_rad</span><span class="p">,</span> <span class="n">src_orth</span> <span class="o">=</span> <span class="n">circular_orbit</span><span class="p">(</span><span class="n">src2obj</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">roll</span> <span class="o">=</span> <span class="n">axs_roll</span><span class="p">,</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">axs_pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                         <span class="n">origin</span> <span class="o">=</span> <span class="n">org</span><span class="p">,</span> <span class="n">tan_shift</span> <span class="o">=</span> <span class="n">src_tan</span> <span class="o">-</span> <span class="n">axs_tan</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">)</span>

        <span class="c1"># Add axial motion:</span>
        <span class="n">vrt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_rng&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_rng&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">proj_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span><span class="p">:</span> <span class="n">vrt</span> <span class="o">=</span> <span class="n">vrt</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">src_vect</span> <span class="o">=</span> <span class="n">src_vect</span> <span class="o">+</span> <span class="n">src_orth</span> <span class="o">*</span> <span class="n">vrt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">src_vect</span></div>


<div class="viewcode-block" id="helical.get_detector_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.helical.get_detector_orbit">[docs]</a>
    <span class="k">def</span> <span class="nf">get_detector_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the detector orbit. In the base class it is a circular orbit.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">det2obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">det2obj</span>

        <span class="c1"># Detector translations:</span>
        <span class="n">det_ort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_ort&#39;</span><span class="p">]</span>
        <span class="n">det_tan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_tan&#39;</span><span class="p">]</span>

        <span class="c1"># Rotation axis translations and rotations:</span>
        <span class="n">axs_tan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_tan&#39;</span><span class="p">]</span>

        <span class="n">axs_roll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_roll&#39;</span><span class="p">]</span>
        <span class="n">axs_pitch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_pitch&#39;</span><span class="p">]</span>

        <span class="c1"># Detector rotations:</span>
        <span class="n">det_roll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_roll&#39;</span><span class="p">]</span>
        <span class="n">det_yaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_yaw&#39;</span><span class="p">]</span>
        <span class="n">det_pitch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_pitch&#39;</span><span class="p">]</span>

        <span class="c1"># Create detector orbit:</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_thetas</span><span class="p">(</span><span class="n">proj_count</span><span class="p">)</span>

        <span class="c1"># det_ort may be a vector or a scalar:</span>
        <span class="n">org</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">det_ort</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">det_pos</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span> <span class="o">=</span> <span class="n">circular_orbit</span><span class="p">(</span><span class="n">det2obj</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">roll</span> <span class="o">=</span> <span class="n">axs_roll</span><span class="p">,</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">axs_pitch</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
                                                         <span class="n">origin</span> <span class="o">=</span> <span class="n">org</span><span class="p">,</span> <span class="n">tan_shift</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_tan</span> <span class="o">+</span> <span class="n">axs_tan</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">)</span>

        <span class="c1"># Add axial motion:</span>
        <span class="n">vrt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_rng&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;axs_rng&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">proj_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span><span class="p">:</span> <span class="n">vrt</span> <span class="o">=</span> <span class="n">vrt</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">det_pos</span> <span class="o">=</span> <span class="n">det_pos</span> <span class="o">+</span> <span class="n">det_orth</span> <span class="o">*</span> <span class="n">vrt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Invert vectors to keep them alligned with the source vectors:</span>
        <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_tan</span><span class="p">,</span> <span class="o">-</span><span class="n">det_rad</span><span class="p">,</span> <span class="o">-</span><span class="n">det_orth</span>

        <span class="c1"># Apply detector rotations:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">det_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">det_roll</span><span class="p">)</span>
            <span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">det_yaw</span><span class="p">)</span>
            <span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">det_pitch</span><span class="p">)</span>
            <span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>

        <span class="k">return</span> <span class="n">det_pos</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span></div>
</div>


<div class="viewcode-block" id="linear">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.linear">[docs]</a>
<span class="k">class</span> <span class="nc">linear</span><span class="p">(</span><span class="n">basic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A simple linear orbit geometry class.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src2obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">det2obj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">det_pixel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">img_pixel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">src_hrz_rng</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">src_vrt_rng</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">det_hrz_rng</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">det_vrt_rng</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mm&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor for the linear geometry class.</span>

<span class="sd">        Args:</span>
<span class="sd">            src2obj  : source to detector distance</span>
<span class="sd">            det2obj  : object to detector distance</span>
<span class="sd">            det_pixel: detector pixel size</span>
<span class="sd">            img_pixel: reconstruction volume voxel size (optional)</span>
<span class="sd">            src_hrz_rng: source horizlontal movement range</span>
<span class="sd">            src_vrt_rng: source vertical movement range</span>
<span class="sd">            det_hrz_rng: detector horizlontal movement range</span>
<span class="sd">            det_vrt_rng: detector vertical movement range</span>
<span class="sd">            unit     : unit length (default = &#39;mm&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Parent init:</span>
        <span class="n">basic</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src2obj</span><span class="p">,</span> <span class="n">det2obj</span><span class="p">,</span> <span class="n">det_pixel</span><span class="p">,</span> <span class="n">img_pixel</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

        <span class="c1"># Additional parameters:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                           <span class="s1">&#39;src_hrz_rng&#39;</span><span class="p">:</span><span class="n">src_hrz_rng</span><span class="p">,</span>   <span class="c1"># source vertical, horizlontal motion range</span>
                           <span class="s1">&#39;src_vrt_rng&#39;</span><span class="p">:</span><span class="n">src_vrt_rng</span><span class="p">,</span>

                           <span class="s1">&#39;det_hrz_rng&#39;</span><span class="p">:</span><span class="n">det_hrz_rng</span><span class="p">,</span>   <span class="c1"># source vertical, horizlontal motion range</span>
                           <span class="s1">&#39;det_vrt_rng&#39;</span><span class="p">:</span><span class="n">det_vrt_rng</span><span class="p">,</span>

                           <span class="s1">&#39;det_roll&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>               <span class="c1"># detector rotations (in degrees)</span>
                           <span class="s1">&#39;det_pitch&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                           <span class="s1">&#39;det_yaw&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                           <span class="p">})</span>

<div class="viewcode-block" id="linear.get_source_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.linear.get_source_orbit">[docs]</a>
    <span class="k">def</span> <span class="nf">get_source_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the source orbit. In the base class it is a circular orbit.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">src2obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src2obj</span>

        <span class="n">src_hrz_rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;src_hrz_rng&#39;</span><span class="p">]</span>
        <span class="n">src_vrt_rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;src_vrt_rng&#39;</span><span class="p">]</span>

        <span class="c1"># Create source orbit:</span>
        <span class="n">src_vect</span><span class="p">,</span> <span class="n">src_tan</span><span class="p">,</span> <span class="n">src_rad</span><span class="p">,</span> <span class="n">serc_ort</span> <span class="o">=</span> <span class="n">linear_orbit</span><span class="p">(</span><span class="n">src_hrz_rng</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">src2obj</span><span class="p">,</span> <span class="o">-</span><span class="n">src2obj</span><span class="p">),</span> <span class="n">src_vrt_rng</span><span class="p">,</span> <span class="n">proj_count</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">src_vect</span></div>


<div class="viewcode-block" id="linear.get_detector_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.linear.get_detector_orbit">[docs]</a>
    <span class="k">def</span> <span class="nf">get_detector_orbit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_count</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the detector orbit. In the base class it is a circular orbit.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">det2obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">det2obj</span>

        <span class="n">det_hrz_rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_hrz_rng&#39;</span><span class="p">]</span>
        <span class="n">det_vrt_rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_vrt_rng&#39;</span><span class="p">]</span>

        <span class="c1"># Detector rotations:</span>
        <span class="n">det_roll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_roll&#39;</span><span class="p">]</span>
        <span class="n">det_yaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_yaw&#39;</span><span class="p">]</span>
        <span class="n">det_pitch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;det_pitch&#39;</span><span class="p">]</span>

        <span class="c1"># Create detector orbit:</span>
        <span class="n">det_pos</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span> <span class="o">=</span> <span class="n">linear_orbit</span><span class="p">(</span><span class="n">det_hrz_rng</span><span class="p">,</span> <span class="p">(</span><span class="n">det2obj</span><span class="p">,</span> <span class="n">det2obj</span><span class="p">),</span> <span class="n">det_vrt_rng</span><span class="p">,</span> <span class="n">proj_count</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="c1"># Apply detector rotations:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">det_pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">det_roll</span><span class="p">)</span>
            <span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">det_yaw</span><span class="p">)</span>
            <span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>

            <span class="n">T</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">det_tan</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">det_pitch</span><span class="p">)</span>
            <span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_rad</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">det_orth</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:])</span>

        <span class="k">return</span> <span class="n">det_pos</span><span class="p">,</span> <span class="n">det_tan</span><span class="p">,</span> <span class="n">det_rad</span><span class="p">,</span> <span class="n">det_orth</span></div>
</div>


<span class="c1"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Static methods &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<div class="viewcode-block" id="tiles_shape">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.tiles_shape">[docs]</a>
<span class="k">def</span> <span class="nf">tiles_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">geometry_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the size of the stiched dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        shape: shape of a single projection stack.</span>
<span class="sd">        geometry_list: list of geometries.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Phisical detector size:</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span>

    <span class="n">det_pixel</span> <span class="o">=</span> <span class="n">geometry_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pixel</span>

    <span class="n">axs_hrz</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Find out the size required for the final dataset</span>
    <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="n">geometry_list</span><span class="p">:</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">detector_bounds</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">min_y</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">max_x</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">max_y</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>

        <span class="n">axs_hrz</span> <span class="o">+=</span> <span class="n">geo</span><span class="p">[</span><span class="s1">&#39;axs_tan&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">geometry_list</span><span class="p">)</span>

    <span class="c1"># Big slice:</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">det_pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">det_pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="c1"># safety margin..</span>

    <span class="c1"># Copy one of the geometry records and sett the correct translation:</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;axs_tan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axs_hrz</span>

    <span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;det_tan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">+</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">axs_hrz</span>
    <span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;det_ort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">+</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Update volume center:</span>
    <span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;vol_tra&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;det_ort&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">geometry</span><span class="o">.</span><span class="n">src2obj</span> <span class="o">+</span> <span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;src_ort&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">geometry</span><span class="o">.</span><span class="n">det2obj</span><span class="p">)</span> <span class="o">/</span> <span class="n">geometry</span><span class="o">.</span><span class="n">src2det</span>
    <span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;vol_tra&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">axs_hrz</span>

    <span class="k">return</span> <span class="n">new_shape</span><span class="p">,</span> <span class="n">geometry</span></div>


<div class="viewcode-block" id="astra_projection_geom">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.astra_projection_geom">[docs]</a>
<span class="k">def</span> <span class="nf">astra_projection_geom</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Initialize ASTRA projection geometry.</span>

<span class="sd">    Args:</span>
<span class="sd">        geom      : geometry class</span>
<span class="sd">        data_shape: [detector_count_z, theta_count, detector_count_x]</span>
<span class="sd">        index     : if provided - sequence of the rotation angles</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">astra_projection_geom</span><span class="p">(</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></div>



<div class="viewcode-block" id="astra_volume_geom">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.astra_volume_geom">[docs]</a>
<span class="k">def</span> <span class="nf">astra_volume_geom</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">vol_shape</span><span class="p">,</span> <span class="n">slice_first</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">slice_last</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Initialize ASTRA volume geometry.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">astra_volume_geom</span><span class="p">(</span><span class="n">vol_shape</span><span class="p">,</span> <span class="n">slice_first</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">slice_last</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_vectors">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.get_vectors">[docs]</a>
<span class="k">def</span> <span class="nf">get_vectors</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">angle_count</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get source, detector and detector orientation vectors.</span>

<span class="sd">    Args:</span>
<span class="sd">        geom       : geometry class</span>
<span class="sd">        angle_count : number of rotation angles</span>
<span class="sd">        index       : index of angles that should be used</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">get_vectors</span><span class="p">(</span><span class="n">angle_count</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></div>


<div class="viewcode-block" id="detector_size">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.detector_size">[docs]</a>
<span class="k">def</span> <span class="nf">detector_size</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">proj_shape</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the size of detector in length units.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">detector_size</span><span class="p">(</span><span class="n">proj_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="detector_bounds">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.detector_bounds">[docs]</a>
<span class="k">def</span> <span class="nf">detector_bounds</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">proj_shape</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the boundaries of the detector in length units.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">detector_bounds</span><span class="p">(</span><span class="n">proj_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="volume_bounds">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.volume_bounds">[docs]</a>
<span class="k">def</span> <span class="nf">volume_bounds</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">proj_shape</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A very simplified version of volume bounds...</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">volume_bounds</span><span class="p">(</span><span class="n">proj_shape</span><span class="p">)</span></div>


<div class="viewcode-block" id="volume_shape">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.volume_shape">[docs]</a>
<span class="k">def</span> <span class="nf">volume_shape</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">proj_shape</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Based on physical volume bnounds compute shape in pixels:</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">geom</span><span class="o">.</span><span class="n">volume_shape</span><span class="p">(</span><span class="n">proj_shape</span><span class="p">)</span></div>



<div class="viewcode-block" id="linear_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.linear_orbit">[docs]</a>
<span class="k">def</span> <span class="nf">linear_orbit</span><span class="p">(</span><span class="n">hrz_rng</span><span class="p">,</span> <span class="n">rad_rng</span><span class="p">,</span> <span class="n">vrt_rng</span><span class="p">,</span> <span class="n">proj_count</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a linear orbit vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        hrz_rng: horizontal range of motion</span>
<span class="sd">        rad_rng: radial range of motion</span>
<span class="sd">        vrt_rng: vertical range of motion</span>

<span class="sd">    Returns:</span>
<span class="sd">        position   : position vector</span>
<span class="sd">        tangent    : tangent direction</span>
<span class="sd">        radius     : radal direction</span>
<span class="sd">        orthogonal : orthogonal direction</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">hrz_rng</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hrz_rng</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">proj_count</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">rad_rng</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rad_rng</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">proj_count</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vrt_rng</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vrt_rng</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">proj_count</span><span class="p">)</span>

    <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">proj_count</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">radius</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">tangent</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">proj_count</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">tangent</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Orthogonal to tangent and radius:</span>
    <span class="n">orthogonal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">tangent</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">position</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">tangent</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">radius</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">orthogonal</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">position</span><span class="p">,</span> <span class="n">tangent</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">orthogonal</span></div>


<div class="viewcode-block" id="circular_orbit">
<a class="viewcode-back" href="../../flexdata.html#flexdata.geometry.circular_orbit">[docs]</a>
<span class="k">def</span> <span class="nf">circular_orbit</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">roll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pitch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tan_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a circular orbit vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        radius     : orbit radius</span>
<span class="sd">        angle_count: number of rotation angles</span>
<span class="sd">        roll, pitch: define orientation of the rotation axis</span>
<span class="sd">        yaw        : initial angular position</span>
<span class="sd">        origin     : xyz vector of the orbit centre</span>
<span class="sd">        tan_shift  : tangential shift from the default position (scalar or array)</span>
<span class="sd">        index      : index of the subset of total rotation angles</span>

<span class="sd">    Returns:</span>
<span class="sd">        position   : position vector</span>
<span class="sd">        tangent    : tangent direction</span>
<span class="sd">        radius     : radal direction</span>
<span class="sd">        orthogonal : orthogonal direction</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Generate axis and orthogonals:</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">_euler2mat_</span><span class="p">(</span><span class="n">pitch</span><span class="p">,</span> <span class="n">roll</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">tan0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">rad0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Genertate initial circular orbit:</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">yaw</span><span class="p">)</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">tan0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tan0</span><span class="p">)</span>
    <span class="n">rad0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rad0</span><span class="p">)</span>

    <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">tangent</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span> <span class="mi">3</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">thetas</span><span class="p">):</span>
        <span class="n">Rt</span> <span class="o">=</span> <span class="n">_axangle2mat_</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">position</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Rt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
        <span class="n">tangent</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Rt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tan0</span><span class="p">)</span>
        <span class="n">radius</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">Rt</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rad0</span><span class="p">)</span>

    <span class="c1"># Apply origin shift:</span>
    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">origin</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="c1"># Apply other shifts:</span>
    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tan_shift</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">+=</span> <span class="n">tangent</span> <span class="o">*</span> <span class="n">tan_shift</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">+=</span> <span class="n">tangent</span> <span class="o">*</span> <span class="n">tan_shift</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># Orthogonal to tangent and radius:</span>
    <span class="n">orthogonal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">tangent</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">position</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">tangent</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">radius</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">orthogonal</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">position</span><span class="p">,</span> <span class="n">tangent</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">orthogonal</span></div>


<span class="k">def</span> <span class="nf">_convertAxesToScipy</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
    <span class="c1"># convert from transforms3d convention to scipy convention</span>
    <span class="k">if</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
        <span class="c1"># &#39;rxyz&#39;, rotating/intrinsic axes -&gt; XYZ</span>
        <span class="k">return</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
        <span class="c1"># &#39;sxyz&#39;, static/extrinsic axes -&gt; xyz</span>
        <span class="k">return</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># assumed to be already in scipy format</span>
        <span class="k">return</span> <span class="n">axes</span>

<span class="k">def</span> <span class="nf">_mat2euler</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;sxyz&#39;</span><span class="p">):</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">_convertAxesToScipy</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">as_euler</span><span class="p">(</span><span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_euler2mat_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;sxyz&#39;</span><span class="p">):</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">_convertAxesToScipy</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">],</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_axangle2mat_</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">ax</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">n</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">n</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="n">n</span>
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Author.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>